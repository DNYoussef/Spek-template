name: Quality Analysis Orchestrator
on:
  workflow_dispatch:
    inputs:
      force_sequential:
        description: 'Force sequential execution mode'
        required: false
        default: 'true'
        type: boolean
  push:
    branches: [main]
    paths:
      - 'analyzer/**'
      - 'src/**'
      - '**/*.py'
      - '**/*.ts'
      - '**/*.js'
  pull_request:
    branches: [main]
    paths:
      - 'analyzer/**'
      - 'src/**'
      - '**/*.py'
      - '**/*.ts'
      - '**/*.js'

jobs:
  quality-orchestrator:
    runs-on: ubuntu-latest
    name: "Quality Analysis Orchestrator"
    timeout-minutes: 90
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Create Artifacts Directory
      run: mkdir -p .claude/.artifacts

    - name: Install Analysis Dependencies
      run: |
        echo "Installing analysis dependencies..."
        pip install --upgrade pip
        # Install core analyzer dependencies
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        # Install analyzer package
        pip install -e ./analyzer || echo "WARNING: Analyzer installation failed, using fallbacks"
        echo "SUCCESS: Analysis dependencies installed"

    - name: Make Scripts Executable
      run: chmod +x .github/scripts/*.py

    - name: Run Connascence Analysis
      run: |
        echo "=== Connascence Analysis ==="
        python .github/scripts/run_connascence_analysis.py
      continue-on-error: false

    - name: Run Architecture Analysis
      run: |
        echo "=== Architecture Analysis ==="
        python .github/scripts/run_architecture_analysis.py
      continue-on-error: false

    - name: Run Performance Monitoring
      run: |
        echo "=== Performance Monitoring ==="
        python .github/scripts/run_performance_monitoring.py
      continue-on-error: false

    - name: Run MECE Analysis
      run: |
        echo "=== MECE Duplication Analysis ==="
        python .github/scripts/run_mece_analysis.py
      continue-on-error: false

    - name: Run Cache Optimization
      run: |
        echo "=== Cache Optimization Analysis ==="
        python .github/scripts/run_cache_optimization.py
      continue-on-error: false

    - name: Run Self-Dogfooding Analysis
      run: |
        echo "=== Self-Dogfooding Analysis ==="
        python .github/scripts/run_dogfooding_analysis.py
      continue-on-error: false

    - name: Consolidate Analysis Results
      run: |
        echo "=== Consolidating Analysis Results ==="
        python .github/scripts/consolidate_analysis_results.py

    - name: Quality Gate Decision
      run: |
        echo "=== Overall Quality Gate Decision ==="
        python .github/scripts/quality_gate_decision.py

    - name: Upload Consolidated Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: consolidated-quality-report-${{ github.run_number }}
        path: |
          .claude/.artifacts/*.json
          .claude/.artifacts/quality_gates_report.json