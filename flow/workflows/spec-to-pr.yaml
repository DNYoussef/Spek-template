name: spec-to-pr
description: Execute SPEC.md end-to-end and open a PR when gates are met.
steps:
  - id: plan
    run: claude /spec:plan
    capture: plan.json
    expect_json: true

  - id: discover_big
    foreach: plan.json.tasks
    when: item.type == "big"
    run: claude /gemini:impact "${{ item.scope }}"
    capture: "gemini/${{ item.id }}.json"

  - id: implement_small
    foreach: plan.json.tasks
    when: item.type == "small"
    run: claude /codex:micro "${{ item.title }}"

  - id: implement_multi
    foreach: plan.json.tasks
    when: item.type == "multi"
    run: claude /fix:planned "${{ item.title }}"

  - id: verify_fan_out
    run: |
      claude /qa:run &
      claude /sec:scan &
      claude /conn:scan &
      wait
    capture: .claude/.artifacts/qa.json
    expect_json: true

  - id: gate
    run: claude --output-format json -p "/qa:gate"
    capture: gate.json
    expect_json: true

  - id: pm_sync
    when: gate.json.ok == true
    run: claude /pm:sync
    capture: pm_sync.json
    expect_json: true

  - id: pr
    when: gate.json.ok == true
    run: claude /pr:open

  - id: gate_failure
    when: gate.json.ok == false
    run: |
      echo "‚ùå Quality gates failed. Artifacts available:"
      ls -la .claude/.artifacts/