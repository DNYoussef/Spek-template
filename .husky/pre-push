#!/bin/sh

# Pre-push hook: Run comprehensive tests
echo "ğŸš€ Running pre-push validation..."

# Check if we're pushing to main/develop
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
    echo "ğŸ”’ Pushing to protected branch: $current_branch"
    echo "ğŸ“‹ Running comprehensive checks..."

    # Run Python tests
    echo "ğŸ§ª Running Python tests..."
    if [ -f "tests/test_analyzer.py" ]; then
        python -m pytest tests/test_analyzer.py -v --tb=short
        if [ $? -ne 0 ]; then
            echo "âŒ Tests failed! Please fix before pushing to $current_branch"
            exit 1
        fi
    fi

    # Check for critical imports
    echo "ğŸ” Validating critical modules..."
    python test_modules.py
    if [ $? -ne 0 ]; then
        echo "âŒ Critical module validation failed!"
        exit 1
    fi

    # Check workflow files for common issues
    echo "ğŸ“ Checking workflow files..."
    for workflow in .github/workflows/*.yml; do
        if [ -f "$workflow" ]; then
            # Check for duplicate workflow_dispatch
            if grep -c "workflow_dispatch:" "$workflow" | grep -q -E '^[2-9]|[0-9]{2,}$'; then
                echo "âš ï¸  Warning: Duplicate workflow_dispatch in $workflow"
            fi
        fi
    done

    echo "âœ… All pre-push checks passed!"
else
    echo "ğŸ“Œ Pushing to feature branch: $current_branch"
    echo "ğŸ’¡ Skipping comprehensive checks (run on main/develop only)"
fi

# Final validation
echo "ğŸ¯ Final validation..."
npm run analyze
if [ $? -ne 0 ]; then
    echo "âš ï¸  Warning: Analyzer validation had issues"
fi

echo "âœ… Pre-push hook completed!"