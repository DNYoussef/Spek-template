#!/bin/sh

# Pre-push hook: Run comprehensive tests
echo "🚀 Running pre-push validation..."

# Check if we're pushing to main/develop
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
    echo "🔒 Pushing to protected branch: $current_branch"
    echo "📋 Running comprehensive checks..."

    # Run Python tests
    echo "🧪 Running Python tests..."
    if [ -f "tests/test_analyzer.py" ]; then
        python -m pytest tests/test_analyzer.py -v --tb=short
        if [ $? -ne 0 ]; then
            echo "❌ Tests failed! Please fix before pushing to $current_branch"
            exit 1
        fi
    fi

    # Check for critical imports
    echo "🔍 Validating critical modules..."
    python test_modules.py
    if [ $? -ne 0 ]; then
        echo "❌ Critical module validation failed!"
        exit 1
    fi

    # Check workflow files for common issues
    echo "📝 Checking workflow files..."
    for workflow in .github/workflows/*.yml; do
        if [ -f "$workflow" ]; then
            # Check for duplicate workflow_dispatch
            if grep -c "workflow_dispatch:" "$workflow" | grep -q -E '^[2-9]|[0-9]{2,}$'; then
                echo "⚠️  Warning: Duplicate workflow_dispatch in $workflow"
            fi
        fi
    done

    echo "✅ All pre-push checks passed!"
else
    echo "📌 Pushing to feature branch: $current_branch"
    echo "💡 Skipping comprehensive checks (run on main/develop only)"
fi

# Final validation
echo "🎯 Final validation..."
npm run analyze
if [ $? -ne 0 ]; then
    echo "⚠️  Warning: Analyzer validation had issues"
fi

echo "✅ Pre-push hook completed!"